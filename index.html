<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#0c0c0c">
<title>Trade Dashboard</title>
<style>
  :root{--fg:#111;--muted:#666;--line:#e6e6e6;--bg:#fff}
  @media (prefers-color-scheme: dark){
    :root{--fg:#eee;--muted:#aaa;--line:#2a2a2a;--bg:#0c0c0c}
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  main{max-width:1000px;margin:20px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:1.35rem}
  .muted{color:var(--muted);font-size:.9rem}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:14px 0}
  .card{border:1px solid var(--line);border-radius:12px;padding:12px}
  .k{font-size:.9rem;color:var(--muted)}
  .v{font-size:1.4rem;font-weight:700;margin-top:4px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left;font-size:.92rem}
  th{font-weight:700}
  .empty{padding:12px;border:1px dashed var(--line);border-radius:12px;color:var(--muted)}
  .ok{color:#22c55e}.bad{color:#ef4444}
  canvas{width:100%;max-width:100%;height:240px}
</style>
</head>
<body>
<main>
  <header>
    <h1>Trade Dashboard</h1>
    <div class="muted" id="updated"></div>
  </header>

  <div class="grid">
    <div class="card"><div class="k">Total Trades</div><div class="v" id="k-total">–</div></div>
    <div class="card"><div class="k">Win Rate</div><div class="v" id="k-winrate">–</div></div>
    <div class="card"><div class="k">Avg R</div><div class="v" id="k-avgR">–</div></div>
    <div class="card"><div class="k">Net R</div><div class="v" id="k-netR">–</div></div>
  </div>

  <div class="card">
    <div class="k">Equity Curve (R)</div>
    <canvas id="eq"></canvas>
    <div class="muted">Based on cumulative R from your CSV.</div>
  </div>

  <div class="card">
    <div class="k">Latest 10 Trades</div>
    <div id="table-wrap"></div>
  </div>

  <div id="empty" class="empty" style="display:none">
    Add a <code>data.csv</code> (Export from Excel). First row should be headers including at least
    <code>Date, Result, R</code>. Optional: <code>Pair, Setup, Week, Notes</code>.
  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
/* --- Robust CSV + date parsing --- */
function parseCSV(text){
  // Split respecting quotes
  const lines = text.replace(/\r/g,'').trim().split('\n');
  const rows = lines.map(line=>{
    const out=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c === '"'){ q = !q; continue; }
      if(c === ',' && !q){ out.push(cur); cur=''; continue; }
      cur += c;
    }
    out.push(cur);
    return out.map(s=>s.trim());
  });

  if(!rows.length) return [];

  // Header map (case-insensitive)
  const header = rows[0].map(h=>h.trim().toLowerCase());
  const idx = Object.fromEntries(header.map((h,i)=>[h,i]));

  // Helper: get column safely (multiple possible names)
  const col = (names) => {
    for (const n of names) if (idx[n] != null) return idx[n];
    return -1;
  };

  const iDate = col(['date']);
  const iResult = col(['result','outcome']);
  const iR = col(['r','rr','net r','netr']);
  const iPair = col(['pair','symbol','asset']);
  const iSetup = col(['setup','strategy','pattern']);
  const iWeek = col(['week','week #','weekno','week number']);
  const iNotes = col(['notes','note','comment','comments']);

  function parseDateFlexible(s){
    if(!s) return null;
    const t = s.trim();

    // 1) 2025-11-05
    let m = t.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if(m) return new Date(Number(m[1]), Number(m[2])-1, Number(m[3]));

    // 2) 1/5/2025 or 11/05/25 (assume MM/DD if first <=12 else DD/MM)
    m = t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
    if(m){
      let a=Number(m[1]), b=Number(m[2]), y=Number(m[3]); if(y<100) y+=2000;
      const mm = (a<=12 && (b>12 || a<=12 && b<=31)) ? a : b;
      const dd = (mm===a) ? b : a;
      return new Date(y, mm-1, dd);
    }

    // 3) 1-Apr-2025 / 01-Apr-2025 / 1 Apr 2025
    m = t.match(/^(\d{1,2})[-\s](Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[-\s](\d{2,4})$/i);
    if(m){
      const dd = Number(m[1]);
      const mon = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'].indexOf(m[2].toLowerCase());
      let y = Number(m[3]); if(y<100) y+=2000;
      if(mon>=0) return new Date(y, mon, dd);
    }

    // 4) Fallback native parser (last resort)
    const d = new Date(t);
    return isNaN(d) ? null : d;
  }

  const data = rows.slice(1).map(r=>{
    const dateStr = iDate>=0 ? r[iDate] : '';
    const d = parseDateFlexible(dateStr);
    const Rraw = iR>=0 ? r[iR] : '';
    const R = parseFloat(String(Rraw).replace(',','.'));
    const result = (iResult>=0 ? r[iResult] : '').trim().toLowerCase();
    return {
      dateStr, dateObj: d,
      pair: iPair>=0 ? r[iPair] : '',
      setup: iSetup>=0 ? r[iSetup] : '',
      result,
      R: Number.isFinite(R) ? R : NaN,
      week: iWeek>=0 ? r[iWeek] : '',
      notes: iNotes>=0 ? r[iNotes] : '',
    };
  }).filter(row=>{
    // Keep rows that have a valid date AND a numeric R
    return row.dateObj instanceof Date && !isNaN(row.dateObj) && Number.isFinite(row.R);
  });

  return data;
}

async function load(){
  document.getElementById('updated').textContent='Loading…';

  let csv;
  try{
    const res = await fetch('data.csv?cb='+Date.now());
    if(!res.ok) throw new Error('no csv');
    csv = await res.text();
  }catch(e){
    document.getElementById('empty').style.display='';
    document.getElementById('updated').textContent='';
    return;
  }

  const trades = parseCSV(csv);
  if(!trades.length){
    document.getElementById('empty').style.display='';
    document.getElementById('updated').textContent='Updated: '+new Date().toLocaleString();
    return;
  }

  // Sort by date ascending
  trades.sort((a,b)=> a.dateObj - b.dateObj);

  // KPIs
  const total = trades.length;
  const wins = trades.filter(t=> t.result.startsWith('win')).length;
  const netR = trades.reduce((s,t)=> s + t.R, 0);
  const avgR = netR / total;
  const winrate = (wins / total) * 100;

  document.getElementById('k-total').textContent = total;
  document.getElementById('k-winrate').textContent = winrate.toFixed(1)+'%';
  document.getElementById('k-avgR').textContent = avgR.toFixed(2);
  document.getElementById('k-netR').textContent = netR.toFixed(2);
  document.getElementById('updated').textContent='Updated: '+new Date().toLocaleString();

  // Equity curve
  let cum=0;
  const labels = trades.map(t=> t.dateStr || t.dateObj.toISOString().slice(0,10));
  const eq = trades.map(t=> (cum += t.R));
  new Chart(document.getElementById('eq'),{
    type:'line',
    data:{labels,datasets:[{data:eq,fill:false,tension:0.2}]},
    options:{responsive:true,plugins:{legend:{display:false}},
      scales:{x:{display:false},y:{ticks:{callback:v=>v+'R'}}}
    }
  });

  // Latest 10
  const last = trades.slice(-10).reverse();
  const rows = last.map(t=>`
    <tr>
      <td>${t.dateStr || t.dateObj.toLocaleDateString()}</td>
      <td>${t.pair||''}</td>
      <td>${t.setup||''}</td>
      <td class="${t.result.startsWith('win')?'ok':(t.result.startsWith('loss')?'bad':'')}">${t.result||''}</td>
      <td>${t.R.toFixed(2)}</td>
      <td>${t.week||''}</td>
      <td>${t.notes||''}</td>
    </tr>
  `).join('');
  document.getElementById('table-wrap').innerHTML = `
    <table>
      <thead><tr>
        <th>Date</th><th>Pair</th><th>Setup</th><th>Result</th><th>R</th><th>Week</th><th>Notes</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

load();
</script>
</body>
</html>
