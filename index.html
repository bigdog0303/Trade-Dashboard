<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#0c0c0c">
<title>Dashboard</title>
<style>
  :root{--fg:#111;--muted:#666;--line:#e6e6e6;--bg:#fff;--accent:#ffd54d;--accentfg:#6b4f00}
  @media (prefers-color-scheme: dark){
    :root{--fg:#eee;--muted:#aaa;--line:#2a2a2a;--bg:#0c0c0c;--accent:#775f1a;--accentfg:#ffd54d}
  }
  html,body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  main{max-width:1000px;margin:20px auto;padding:0 16px}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:1.35rem}
  .muted{color:var(--muted);font-size:.9rem}

  .controls{display:flex;gap:8px;align-items:center;margin:10px 0 0;flex-wrap:wrap}
  .btn{border:1px solid var(--line);background:transparent;color:var(--fg);padding:6px 10px;border-radius:10px;font-size:.9rem;cursor:pointer}
  .btn.active{background:var(--accent);color:var(--accentfg);border-color:transparent}
  .range-note{margin-left:8px;color:var(--muted);font-size:.9rem}

  .month-controls{display:none;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
  .month-controls.show{display:flex}
  select, input[type="text"]{border:1px solid var(--line);background:transparent;color:var(--fg);padding:6px 10px;border-radius:10px;font-size:.95rem}

  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin:14px 0}
  .card{border:1px solid var(--line);border-radius:12px;padding:12px}
  .k{font-size:.9rem;color:var(--muted)}
  .v{font-size:1.4rem;font-weight:700;margin-top:4px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid var(--line);padding:8px 6px;text-align:left;font-size:.92rem}
  th{font-weight:700}
  .empty{padding:12px;border:1px dashed var(--line);border-radius:12px;color:var(--muted)}
  .ok{color:#22c55e}.bad{color:#ef4444}
  canvas{width:100%;max-width:100%;height:240px}

  /* ---------- Modal ---------- */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:flex-end;justify-content:center}
  .modal-backdrop.show{display:flex}
  .modal{background:var(--bg);color:var(--fg);width:min(680px,100%);max-height:90vh;border-radius:16px 16px 0 0;border:1px solid var(--line);box-shadow:0 10px 30px rgba(0,0,0,.35);padding:14px 14px 18px;overflow:auto}
  .modal h2{margin:4px 0 8px;font-size:1.1rem}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:8px 0}
  .input{flex:1;min-width:260px}
  .help{font-size:.85rem;color:var(--muted)}
  .drop{border:1px dashed var(--line);border-radius:12px;padding:10px;text-align:center;font-size:.9rem}
  .drop.drag{outline:2px dashed var(--accentfg);outline-offset:2px}
</style>
</head>
<body>
<main>
  <header>
    <div>
      <h1>Trade Dashboard</h1>

      <div class="controls">
        <button id="allBtn"  class="btn">All</button>
        <button id="weekBtn" class="btn">This Week</button>
        <button id="monthTabBtn" class="btn">Monthly</button>
        <span id="rangeNote" class="range-note"></span>
      </div>

      <div id="monthControls" class="month-controls">
        <label for="monthSelect" class="muted">Month:</label>
        <select id="monthSelect"></select>
      </div>
    </div>

    <div style="display:flex;align-items:center;gap:8px">
      <span class="muted" id="updated"></span>
      <button id="openSettings" class="btn">⚙️ Settings</button>
    </div>
  </header>

  <div class="grid">
    <div class="card"><div class="k">Total Trades</div><div class="v" id="k-total">–</div></div>
    <div class="card"><div class="k">Win Rate</div><div class="v" id="k-winrate">–</div></div>
    <div class="card"><div class="k">Expectancy (R/trade)</div><div class="v" id="k-exp">–</div></div>
    <div class="card"><div class="k">Net R</div><div class="v" id="k-netR">–</div></div>
  </div>

  <div class="card">
    <div class="k">Equity Curve (R)</div>
    <canvas id="eq"></canvas>
    <div class="muted" id="note"></div>
  </div>

  <div class="card">
    <div class="k" id="tableTitle">Latest 10 Trades</div>
    <div id="table-wrap"></div>
  </div>

  <div id="empty" class="empty" style="display:none">
    Add a <code>data.csv</code> (or set a OneDrive CSV in Settings, or upload a file there) with headers including at least <code>Date, Result, R</code>.
  </div>
</main>

<!-- Settings Modal -->
<div id="modalBg" class="modal-backdrop" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 id="settingsTitle">Data Settings</h2>
      <button id="closeSettings" class="btn">Close</button>
    </div>

    <div class="row help">Choose a source. If none is set, the app uses <code>data.csv</code> in this folder.</div>

    <div class="row">
      <input id="onedriveUrl" class="input" type="text" placeholder="OneDrive CSV link (public view)" />
      <button id="saveSource" class="btn">Save Source</button>
      <button id="clearSource" class="btn">Clear</button>
    </div>
    <div class="row help" id="sourceStatus">Source: default (upload or data.csv)</div>

    <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

    <div class="row">
      <input id="filePicker" type="file" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:none">
      <button id="uploadBtn" class="btn">Upload .xlsx/.csv</button>
      <div id="drop" class="drop">Drop Excel/CSV here</div>
    </div>
    <div class="help">Uploads are local to this browser session (no server).</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
/* ---------- CSV parser ---------- */
function parseCSV(text){
  const lines = text.replace(/\r/g,'').trim().split('\n');
  if(!lines.length) return [];
  const rows = lines.map(line=>{
    const out=[]; let cur=''; let q=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c === '"'){ q=!q; continue; }
      if(c === ',' && !q){ out.push(cur); cur=''; continue; }
      cur += c;
    }
    out.push(cur);
    return out.map(s=>s.trim());
  });

  const header = rows[0].map(h=>h.trim().toLowerCase());
  const iDate   = header.indexOf('date');
  const iResult = header.indexOf('result');
  const iR      = header.indexOf('r');
  if (iDate < 0 || iResult < 0 || iR < 0) return [];

  function parseDateFlexible(s){
    if(!s) return null;
    const t = s.trim();
    let m = t.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
    if(m) return new Date(+m[1], +m[2]-1, +m[3]);
    m = t.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
    if(m){ let a=+m[1], b=+m[2], y=+m[3]; if(y<100) y+=2000;
      const mm = (a<=12 && (b>12 || b<=31)) ? a : b;
      const dd = (mm===a) ? b : a;
      return new Date(y, mm-1, dd);
    }
    m = t.match(/^(\d{1,2})[-\s](Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[-\s](\d{2,4})$/i);
    if(m){
      const dd = +m[1];
      const mon = ['jan','feb','mar','apr','may','jun','jul','aug','sep','oct','nov','dec'].indexOf(m[2].toLowerCase());
      let y = +m[3]; if(y<100) y+=2000;
      if(mon>=0) return new Date(y, mon, dd);
    }
    const d = new Date(t); return isNaN(d) ? null : d;
  }

  const cleanNum = x => parseFloat(String(x??'').replace(/[−–—]/g,'-').replace(',','.'));
  const isWin  = s => /^\s*(\d+\s*)?win\s*$/i.test(s);
  const isLoss = s => /^\s*(\d+\s*)?loss\s*$/i.test(s);

  const trades = rows.slice(1).map(r=>{
    const dateStr = r[iDate] ?? '';
    const dateObj = parseDateFlexible(dateStr);
    const resultRaw = (r[iResult] ?? '').trim();
    const R = cleanNum(r[iR]);
    return { dateStr, dateObj, resultRaw, R };
  }).filter(row=>{
    if(!(row.dateObj instanceof Date) || isNaN(row.dateObj)) return false;
    return isWin(row.resultRaw) || isLoss(row.resultRaw);
  }).map(row=>{
    row.cls = /^\s*(\d+\s*)?win\s*$/i.test(row.resultRaw) ? 'win' : 'loss';
    row.monthKey = `${row.dateObj.getFullYear()}-${String(row.dateObj.getMonth()+1).padStart(2,'0')}`;
    return row;
  });

  trades.sort((a,b)=> a.dateObj - b.dateObj);
  return trades;
}

/* ---------- Helpers ---------- */
function startOfThisWeek(d=new Date()){ const x=new Date(d.getFullYear(),d.getMonth(),d.getDate()); const dow=x.getDay(); const diff=(dow===0?-6:1-dow); x.setDate(x.getDate()+diff); x.setHours(0,0,0,0); return x; }
function endOfThisWeek(d=new Date()){ const s=startOfThisWeek(d); const e=new Date(s); e.setDate(s.getDate()+7); return e; }
function monthLabelFromKey(k){ const [y,m]=k.split('-').map(n=>+n); return new Date(y,m-1,1).toLocaleDateString([], {month:'short', year:'numeric'}); }
function fmtShort(d){ return d.toLocaleDateString([], {month:'short', day:'2-digit'}); }
function metrics(trades){
  const wins=trades.filter(t=>t.cls==='win'), losses=trades.filter(t=>t.cls==='loss');
  const total=wins.length+losses.length;
  const winR=wins.reduce((s,t)=>s+(Number.isFinite(t.R)?t.R:0),0);
  const lossR=losses.reduce((s,t)=>s+(Number.isFinite(t.R)?t.R:0),0);
  const avgWin=wins.length?(winR/wins.length):0;
  const avgLoss=losses.length?(lossR/losses.length):0;
  const pW=total?(wins.length/total):0, pL=1-pW;
  const expectancy=pW*avgWin+pL*avgLoss;
  const netR=winR+lossR, winrate=total?(wins.length/total*100):0;
  return { total, winrate, expectancy, netR, wins:wins.length, losses:losses.length };
}

/* ---------- State ---------- */
let ALL_TRADES=[];
let MODE=localStorage.getItem('mode')||'all';
let ACTIVE_MONTH=localStorage.getItem('active_month')||null;
let chart;

/* ---------- Elements ---------- */
const monthControls=document.getElementById('monthControls');
const monthSelect=document.getElementById('monthSelect');
const rangeNote=document.getElementById('rangeNote');
const tableTitle=document.getElementById('tableTitle');
const updatedEl=document.getElementById('updated');
const modalBg=document.getElementById('modalBg');
const openSettings=document.getElementById('openSettings');
const closeSettings=document.getElementById('closeSettings');
const onedriveUrl=document.getElementById('onedriveUrl');
const saveSource=document.getElementById('saveSource');
const clearSource=document.getElementById('clearSource');
const sourceStatus=document.getElementById('sourceStatus');
const filePicker=document.getElementById('filePicker');
const uploadBtn=document.getElementById('uploadBtn');
const drop=document.getElementById('drop');

/* ---------- Mode buttons ---------- */
document.getElementById('allBtn').onclick=()=>{ MODE='all'; ACTIVE_MONTH=null; persistView(); setTabs(); render(); };
document.getElementById('weekBtn').onclick=()=>{ MODE='week'; ACTIVE_MONTH=null; persistView(); setTabs(); render(); };
document.getElementById('monthTabBtn').onclick=()=>{ MODE='month'; persistView(); setTabs(); render(); };
function persistView(){ localStorage.setItem('mode',MODE); if(ACTIVE_MONTH) localStorage.setItem('active_month',ACTIVE_MONTH); }
function setTabs(){
  document.getElementById('allBtn').classList.toggle('active', MODE==='all');
  document.getElementById('weekBtn').classList.toggle('active', MODE==='week');
  document.getElementById('monthTabBtn').classList.toggle('active', MODE==='month');
}

/* ---------- Modal wiring ---------- */
function openModal(){
  const saved = localStorage.getItem('onedriveCsvUrl')||'';
  onedriveUrl.value = saved;
  sourceStatus.textContent = saved ? 'Source: OneDrive CSV' : 'Source: default (upload or data.csv)';
  modalBg.classList.add('show');
  modalBg.setAttribute('aria-hidden','false');
}
function closeModal(){
  modalBg.classList.remove('show');
  modalBg.setAttribute('aria-hidden','true');
}
openSettings.onclick=openModal;
closeSettings.onclick=closeModal;
modalBg.addEventListener('click',e=>{ if(e.target===modalBg) closeModal(); });
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeModal(); });

saveSource.onclick=()=>{
  const v=onedriveUrl.value.trim();
  if(v){ localStorage.setItem('onedriveCsvUrl', v); sourceStatus.textContent='Source: OneDrive CSV'; }
  else { localStorage.removeItem('onedriveCsvUrl'); sourceStatus.textContent='Source: default (upload or data.csv)'; }
  load(); // reload from new source
};
clearSource.onclick=()=>{
  localStorage.removeItem('onedriveCsvUrl');
  onedriveUrl.value='';
  sourceStatus.textContent='Source: default (upload or data.csv)';
  load();
};

/* ---------- Upload handlers (inside modal) ---------- */
uploadBtn.onclick=()=>filePicker.click();
filePicker.addEventListener('change', async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  await loadFromFile(f);
});
['dragenter','dragover'].forEach(ev=>{
  drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add('drag'); });
});
['dragleave','drop'].forEach(ev=>{
  drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove('drag'); });
});
drop.addEventListener('drop', async e=>{
  const f=e.dataTransfer.files?.[0]; if(!f) return;
  await loadFromFile(f);
});

/* ---------- Render ---------- */
function render(){
  const months=Array.from(new Set(ALL_TRADES.map(t=>t.monthKey))).sort();
  if(MODE==='month'){
    monthControls.classList.add('show');
    if(!ACTIVE_MONTH && months.length) ACTIVE_MONTH = months[months.length-1];
    monthSelect.innerHTML = months.map(mk=>`<option value="${mk}" ${mk===ACTIVE_MONTH?'selected':''}>${monthLabelFromKey(mk)}</option>`).join('');
  } else {
    monthControls.classList.remove('show');
  }
  monthSelect.onchange=()=>{ ACTIVE_MONTH=monthSelect.value; localStorage.setItem('active_month',ACTIVE_MONTH); render(); };

  let filtered=ALL_TRADES;
  if(MODE==='week'){
    const s=startOfThisWeek(), e=endOfThisWeek();
    filtered=ALL_TRADES.filter(t=>t.dateObj>=s && t.dateObj<e);
    rangeNote.textContent=`This week: ${fmtShort(s)} — ${fmtShort(new Date(e.getTime()-86400000))}`;
    tableTitle.textContent='Latest 10 Trades';
  } else if(MODE==='month' && ACTIVE_MONTH){
    filtered=ALL_TRADES.filter(t=>t.monthKey===ACTIVE_MONTH);
    rangeNote.textContent=monthLabelFromKey(ACTIVE_MONTH);
    tableTitle.textContent='All Trades (Selected Month)';
  } else {
    rangeNote.textContent='All trades';
    tableTitle.textContent='Latest 10 Trades';
  }

  const { total, winrate, expectancy, netR, wins, losses } = metrics(filtered);
  document.getElementById('k-total').textContent=total;
  document.getElementById('k-winrate').textContent=isFinite(winrate)?winrate.toFixed(1)+'%':'–';
  document.getElementById('k-exp').textContent=isFinite(expectancy)?expectancy.toFixed(2):'–';
  document.getElementById('k-netR').textContent=isFinite(netR)?netR.toFixed(2):'–';
  document.getElementById('note').textContent=`Wins: ${wins} · Losses: ${losses}`;

  let cum=0;
  const labels=filtered.map(t=> t.dateStr || t.dateObj.toISOString().slice(0,10));
  const eq=filtered.map(t=> (cum += (Number.isFinite(t.R)?t.R:0)));
  const ctx=document.getElementById('eq');
  if(chart) chart.destroy();
  chart=new Chart(ctx,{type:'line',data:{labels,datasets:[{data:eq,fill:false,tension:0.2}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{x:{display:false},y:{ticks:{callback:v=>v+'R'}}}}});

  let rows=filtered;
  if(MODE!=='month'){ rows=filtered.slice(-10).reverse(); }
  else { rows=[...filtered].reverse(); }
  const rowsHtml=rows.map(t=>{
    const cls=t.cls==='win'?'ok':'bad';
    return `<tr><td>${t.dateStr || t.dateObj.toLocaleDateString()}</td><td class="${cls}">${t.cls==='win'?'Win':'Loss'}</td><td>${Number.isFinite(t.R)?t.R.toFixed(2):''}</td></tr>`;
  }).join('');
  document.getElementById('table-wrap').innerHTML=`<table><thead><tr><th>Date</th><th>Result</th><th>R</th></tr></thead><tbody>${rowsHtml}</tbody></table>`;
}

/* ---------- Data loading ---------- */
async function fetchText(url){ const res=await fetch(url,{cache:'no-store'}); if(!res.ok) throw new Error('Fetch failed: '+res.status); return res.text(); }
async function loadFromOneDriveIfSet(){
  const url=localStorage.getItem('onedriveCsvUrl'); if(!url) return null;
  try{ const csv=await fetchText(url + (url.includes('?')?'&':'?') + 'cb='+Date.now()); sourceStatus.textContent='Source: OneDrive CSV'; return csv; }
  catch(e){ console.warn('OneDrive fetch failed',e); sourceStatus.textContent='Source: default (upload or data.csv)'; return null; }
}
async function loadFromDataCsv(){ try{ const csv=await fetchText('data.csv?cb='+Date.now()); sourceStatus.textContent='Source: data.csv'; return csv; }catch(e){ return null; } }
async function loadFromFile(file){
  updatedEl.textContent='Loading…';
  try{
    let csvText='';
    if(/\.(xlsx|xlsm?|xltx|xltm)$/i.test(file.name)){
      const buf=await file.arrayBuffer();
      const wb=XLSX.read(buf,{type:'array'});
      const first=wb.SheetNames[0];
      csvText=XLSX.utils.sheet_to_csv(wb.Sheets[first]);
    } else {
      csvText=await file.text();
    }
    const trades=parseCSV(csvText);
    if(!trades.length) throw new Error('No valid trades found in file.');
    ALL_TRADES=trades;
    document.getElementById('empty').style.display='none';
    updatedEl.textContent='Updated (uploaded): '+new Date().toLocaleString();
    render();
  }catch(e){
    console.error(e);
    document.getElementById('empty').style.display='';
    updatedEl.textContent='Failed to parse upload.';
  }
}

/* ---------- Boot ---------- */
async function load(){
  updatedEl.textContent='Loading…';
  let csv=await loadFromOneDriveIfSet();
  if(!csv) csv=await loadFromDataCsv();

  if(!csv){ document.getElementById('empty').style.display=''; updatedEl.textContent=''; setTabs(); return; }
  const trades=parseCSV(csv);
  if(!trades.length){ document.getElementById('empty').style.display=''; updatedEl.textContent='Updated: '+new Date().toLocaleString(); setTabs(); return; }

  ALL_TRADES=trades;
  document.getElementById('empty').style.display='none';
  updatedEl.textContent='Updated: '+new Date().toLocaleString();

  const months=Array.from(new Set(ALL_TRADES.map(t=>t.monthKey))).sort();
  if(MODE==='month' && (!ACTIVE_MONTH || !months.includes(ACTIVE_MONTH))){
    ACTIVE_MONTH=months[months.length-1]||null;
    localStorage.setItem('active_month',ACTIVE_MONTH||'');
  }
  setTabs(); render();
}

setTabs(); load();
</script>
</body>
</html>
